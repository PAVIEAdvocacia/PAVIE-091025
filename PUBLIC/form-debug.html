<!doctype html><html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Debug do Formulário | PAVIE</title>
  <style>body{font-family:system-ui,Arial,sans-serif;margin:24px;max-width:820px} code{background:#f4f4f4;padding:3px 6px;border-radius:4px}</style>
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsOnload" async defer></script>
  <script>
  let tsWidget = null;
  window.tsOnload = function(){
    tsWidget = turnstile.render('#ts-container', {
      sitekey: '0x4AAAAAAB6FBS0cTG_7KOYv',
      theme: 'auto',
      callback: function(token){
        document.querySelector('#token').textContent = token || '(vazio)';
        document.querySelector('#status').textContent = 'Pronto para enviar';
      },
      'expired-callback': function(){
        document.querySelector('#status').textContent = 'Token expirado — recarregue o captcha';
      },
      'error-callback': function(){
        document.querySelector('#status').textContent = 'Erro no Turnstile — recarregue a página';
      }
    });
  };
  async function doSubmit(e){
    e.preventDefault();
    const fd = new FormData(e.target);
    const res = await fetch('/api/contato', { method:'POST', body: fd });
    const data = await res.json().catch(()=>({raw: await res.text()}));
    document.querySelector('#out').textContent = JSON.stringify(data,null,2);
  }
  function resetToken(){
    try{ turnstile.reset(tsWidget); document.querySelector('#token').textContent='(redefinido)'; }catch(e){}
  }
  </script>
</head>
<body>
  <h1>Debug do Formulário</h1>
  <p><strong>Status:</strong> <span id="status">Carregando…</span></p>
  <p><strong>Token Turnstile:</strong> <code id="token">(ainda não)</code> <button onclick="resetToken()">resetar</button></p>

  <form id="f" method="post" action="/api/contato" onsubmit="doSubmit(event)">
    <label>Nome<br><input name="name" required></label><br><br>
    <label>Email<br><input type="email" name="email" required></label><br><br>
    <label>Mensagem<br><textarea name="message" required></textarea></label><br><br>
    <div id="ts-container"></div>
    <button type="submit">Enviar</button>
  </form>

  <h3>Resposta da API</h3>
  <pre id="out" style="background:#0b1426; color:#d7ffde; padding:12px; border-radius:6px; overflow:auto"></pre>

  <p>Se esta página funcionar e o site principal não, o problema está no HTML do formulário (action/method ou inclusão dos scripts). Sem alterar seu layout, inclua:</p>
  <ol>
    <li><code>&lt;script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=tsOnload" async defer&gt;&lt;/script&gt;</code></li>
    <li><code>&lt;script src="/form.turnstile.js"&gt;&lt;/script&gt;</code> (ou remova se você preferir inline)</li>
    <li>No &lt;form&gt; use <code>method="post"</code> e <code>action="/api/contato"</code>.</li>
    <li>Inclua <code>&lt;div id="ts-container" data-sitekey="0x4AAAAAAB6FBS0cTG_7KOYv"&gt;&lt;/div&gt;</code>.</li>
  </ol>
</body>
</html>