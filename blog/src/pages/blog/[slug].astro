---
// src/pages/blog/[slug].astro
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;

// Derivações e "fallbacks" seguros
const site = Astro.site ?? new URL('https://blog.pavieadvocacia.com.br');
const canonical = new URL(`/blog/${post.slug}/`, site).toString();

const title = `${post.data.title} — PAVIE | Blog`;
const description = post.data.description ?? '';
const published = post.data.date instanceof Date ? post.data.date : new Date(post.data.date);
const modified = post.data.updatedAt ? new Date(post.data.updatedAt) : published;

const tags = Array.isArray(post.data.tags) ? post.data.tags : (post.data.tags ? [post.data.tags] : []);
const image = typeof post.data.image === 'string' ? post.data.image : post.data.image?.src;

// Filtros Pagefind (Eixo / Tipo / Jurisdicao)
const eixos = Array.isArray(post.data.eixos) ? post.data.eixos : (post.data.eixo ? [post.data.eixo] : []);
const tipo = post.data.tipo ?? 'Artigo';
const jurisdicao = post.data.jurisdicao ?? 'Brasil';

// Publisher / Author (ajuste conforme seu frontmatter)
const authorName = post.data.author ?? 'PAVIE | Advocacia';
const publisherName = 'PAVIE | Advocacia';

// JSON-LD (BlogPosting)
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.data.title,
  description,
  datePublished: published.toISOString(),
  dateModified: modified.toISOString(),
  mainEntityOfPage: canonical,
  url: canonical,
  image: image ? [image] : undefined,
  author: [{ '@type': 'Person', name: authorName }],
  publisher: {
    '@type': 'Organization',
    name: publisherName,
    logo: {
      '@type': 'ImageObject',
      // Substitua por sua logo canônica quando disponível:
      url: new URL('/favicon-512.png', site).toString()
    }
  },
  keywords: tags.length ? tags.join(', ') : undefined
};
---

<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonical} />

    <!-- Open Graph / Twitter -->
    <meta property="og:type" content="article" />
    <meta property="og:title" content={post.data.title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonical} />
    {image && <meta property="og:image" content={image} />}
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={post.data.title} />
    <meta name="twitter:description" content={description} />
    {image && <meta name="twitter:image" content={image} />}

    <!-- Schema.org JSON-LD (BlogPosting) -->
    <script type="application/ld+json">
      {JSON.stringify(jsonLd)}
    </script>

    <!-- Metadados para Pagefind -->
    <meta data-pagefind-meta="title" content={post.data.title} />
    <meta data-pagefind-meta="description" content={description} />
    <meta data-pagefind-meta="url" content={canonical} />
    {image && <meta data-pagefind-meta="image" content={image} />}

    <!-- Filtros Pagefind -->
    {eixos.map((e) => <meta data-pagefind-filter={`Eixo: ${e}`} />)}
    <meta data-pagefind-filter={`Tipo: ${tipo}`} />
    <meta data-pagefind-filter={`Jurisdicao: ${jurisdicao}`} />
    {tags.map((t) => <meta data-pagefind-filter={`Tag: ${t}`} />)}
  </head>

  <body>
    <article data-pagefind-body>
      <header>
        <h1>{post.data.title}</h1>
        <p>
          <time datetime={published.toISOString()}>
            {published.toLocaleDateString('pt-BR')}
          </time>
          {modified.getTime() !== published.getTime() && (
            <>
              {' · atualizado em '}
              <time datetime={modified.toISOString()}>
                {modified.toLocaleDateString('pt-BR')}
              </time>
            </>
          )}
        </p>
        {tags.length > 0 && (
          <p>
            <strong>Palavras-chave:</strong> {tags.join(', ')}
          </p>
        )}
      </header>

      <!-- Corpo do post a ser indexado pelo Pagefind -->
      <div class="content flow">
        <slot />
      </div>

      <footer>
        <p><small>Autor: {authorName} · Publicado por {publisherName}</small></p>
      </footer>
    </article>
  </body>
</html>
